!function(t){var e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)s.d(i,a,function(e){return t[e]}.bind(null,a));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);const i="mouse_1";class a{constructor(t){this.element=t,this.keyState={},this.keyUpState={},this.mouseState={x:0,y:0},document.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("mousemove",this.onMouseMove.bind(this))}onMouseUp(t){const e=this.getCursorPosition(t);switch(this.mouseState.x=e.x,this.mouseState.y=e.y,t.which){case 1:return void(this.keyState[i]=!1)}}onMouseDown(t){const e=this.getCursorPosition(t);switch(this.mouseState.x=e.x,this.mouseState.y=e.y,t.which){case 1:return void(this.keyState[i]=!0)}}onMouseMove(t){const e=this.getCursorPosition(t);this.mouseState.x=e.x,this.mouseState.y=e.y}getMouseX(){return this.mouseState.x}getMouseY(){return this.mouseState.y}getMousePosition(){return[this.getMouseX(),this.getMouseY()]}reset(){this.keyUpState={}}update(t){this.keyUpState={},this.keyState=Object.keys(this.keyState).reduce((t,e)=>!1===this.keyState[e]?(delete this.keyState[e],this.keyUpState[e]=!0,t):(t[e]=this.keyState[e],t),{})}isKeyUp(t){return!0===this.keyUpState[t]}isKeyPress(t){return!0===this.keyState[t]}getCursorPosition(t){const e=this.element.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}}class r{constructor(){this.assetsSrc={},this.assets={}}add(t,e){return this.assetsSrc[t]=e,this}get(t){return this.assets[t]||null}getAssetLoader(t,e){switch(e.split(".").pop()){case"jpg":case"png":return new n(t,e);case"mp3":case"wav":return new h(t,e);default:return null}}load(){const t=Object.keys(this.assetsSrc).map(t=>{const e=this.getAssetLoader(t,this.assetsSrc[t]);if(null===e)throw new Error(`Loader for file ${this.assetsSrc[t]} not found`);return e.load().then(e=>(this.assets[t]=e,e))});return Promise.all(t)}}class n{constructor(t,e){this.url=e,this.name=t,this.data=null}load(){return new Promise((t,e)=>{const s=new Image;s.onerror=(()=>{e(this.url)}),s.onload=(()=>{this.data=s,t(this)}),s.src=this.url})}}class h{constructor(t,e){this.url=e,this.name=t,this.data=null}load(){return new Promise((t,e)=>{const s=document.createElement("audio");s.setAttribute("src",this.url),s.addEventListener("canplay",()=>{this.data=s,t(this)},!0),s.addEventListener("error",()=>{e(this.url)}),s.load()})}}const o=()=>{let t=null,e=null;return{promise:new Promise((s,i)=>{t=s,e=i}),resolve:e=>t(e),reject:t=>e(t)}};class u{constructor(){this.tweenList=[]}create(t,e={},s=1e4){const i=o(),a={isLoop:!0,object:t,duration:s,currentTime:0,easing:t=>t<.5?2*t*t:(4-2*t)*t-1,params:[],deferred:i};return Object.keys(e).map(s=>{a.params.push({param:s,start:t[s],end:e[s]})}),this.tweenList.push(a),i.promise}update(t){this.tweenList=this.tweenList.filter(e=>{let s=!1;return e.currentTime+=t,e.currentTime>e.duration&&(e.currentTime=e.duration,s=!0),e.params.map(t=>{const s=e.easing(e.currentTime/e.duration),i=t.start+(t.end-t.start)*s;e.object[t.param]=i}),!0===s&&e.deferred.resolve(),!s})}}class d{constructor(t){this.game=t,this.states={},this.currentState=null}add(t,e){this.states[t]=e}change(t){const e=new(0,this.states[t])(this.game);e.init(),null!==this.currentState&&this.currentState.leave(),this.currentState=e,e.enter()}update(t){null!==this.currentState&&this.currentState.update(t)}draw(t){null!==this.currentState&&this.currentState.draw(t)}}class c{constructor(){this.lastTick=null,this.canvas=null,this.context=null,this.tick=this.tick.bind(this),this.canvas=document.getElementById("game"),this.context=this.canvas.getContext("2d"),this.inputManager=new a(this.canvas),this.assetManager=new r,this.tweenManager=new u,this.stateManager=new d(this)}start(t=null){this.init(),this.assetManager.load().then(()=>{this.stateManager.change(t),this.lastTick=Date.now(),window.requestAnimationFrame(this.tick)})}tick(){const t=Date.now(),e=Date.now()-this.lastTick;this.lastTick=t,this.inputManager.update(e),this.tweenManager.update(e),this.stateManager.update(e),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.stateManager.draw(this.context),window.requestAnimationFrame(this.tick)}init(){}}class l{constructor({x:t=0,y:e=0,width:s=0,height:i=0,sprite:a=null,angle:r=0,animation:n=null,isVisible:h=!0}={}){this.x=t,this.y=e,this.scaleX=1,this.scaleY=1,this.angle=r,this.sprite=a,this.isVisible=h,this.animations=[],this.currentAnimation=null,this.currentFrame=null,this.width=s,this.height=i,null!==this.sprite&&0===this.width&&0===this.height&&(this.width=this.sprite.data.width,this.height=this.sprite.data.height),this.children=[]}addChild(t){this.children.push(t)}removeChild(t){const e=this.children.indexOf(t);if(-1===e)return!1;this.children.splice(e,1)}addAnimation(t,e){this.animations[t]=e}getFrame(){if(null!==this.currentAnimation){return this.animations[this.currentAnimation].getFrame()}return null!==this.currentFrame?this.currentFrame:{x:0,y:0,width:this.width,height:this.height}}update(t){null!==this.currentAnimation&&this.animations[this.currentAnimation].update(t),this.children.map(e=>{e.update(t)})}draw(t){if(!1!==this.isVisible){if(t.save(),t.translate(this.x,this.y),t.save(),t.translate(this.width/2,this.height/2),t.scale(this.scaleX,this.scaleY),t.translate(-this.width/2,-this.height/2),0!==this.angle&&(t.translate(this.width/2,this.height/2),t.rotate(this.angle*Math.PI/180),t.translate(-this.width/2,-this.height/2)),null!==this.sprite){const e=this.getFrame();t.drawImage(this.sprite.data,e.x,e.y,e.width,e.height,0,0,e.width,e.height)}this.children.map(e=>{e.draw(t)}),t.restore(),t.restore()}}}class g{constructor(t){this.game=t,this.root=new l}load(){}init(){}enter(){}update(t){this.root.update(t)}draw(t){this.root.draw(t)}leave(){}}const m="idle",p="animate";class w extends l{constructor(t,e=0,s=!1,i={}){super({...i,sprite:t.get("sprite")}),this.currentFrame={x:64*e,y:128+(s?0:64),width:64,height:64},this.state=m,this.isActive=s,this.type=e}update(...t){this.currentFrame={x:64*this.type,y:128+(this.isActive?0:64),width:64,height:64},super.update(...t)}}const f="once",y="loop";class M{constructor({duration:t=0,type:e=f,frames:s=[]}={}){this.duration=t,this.type=e,this.currentTime=0,this.frames=s}getFrame(){if(this.currentTime===this.duration){if(this.type===f)return this.frames[this.frames.length-1];this.type===y&&(this.currentTime=0)}const t=this.duration/this.frames.length,e=Math.floor(this.currentTime/t);return this.frames[e]}reset(){this.currentTime=0}update(t){this.currentTime+=t,this.currentTime=this.duration<=this.currentTime?this.duration:this.currentTime}}class v{constructor(t=0,e=0,s=0,i=0){this.sheetX=t,this.sheetY=e,this.frameX=s,this.frameY=i}build(t=[],e={}){if(0===this.sheetX||0===this.sheetY||0===this.frameX||0===this.frameY)throw new Error("Size error");const s=t.map(t=>{return{x:t*this.frameX%this.sheetX,y:Math.floor(t*this.frameX/this.sheetX),width:this.frameX,height:this.frameY}});return new M({...e,frames:s})}}class S extends l{constructor(...t){super(...t);const e=new v(320,256,64,64),s=e.build([0],{duration:200});this.addAnimation("idle",s);const i=e.build([0,1,2,3],{duration:500,type:y});this.addAnimation("active",i),this.currentAnimation="active"}}class x extends l{constructor(t,e={}){super({...e,sprite:t.get("sprite"),width:64,height:64}),this.isActive=!1,this.currentFrame={x:0,y:this.height,width:this.width,height:this.height}}draw(...t){this.currentFrame={x:this.width*(!0===this.isActive?1:0),y:this.height,width:this.width,height:this.height},super.draw(...t)}}class b extends l{constructor(t,e,s,i){super({x:t,y:e}),this.assetManager=s,this.state=[],this.roadLayer=new l({}),this.buildingLayer=new l({}),this.addChild(this.roadLayer),this.addChild(this.buildingLayer);for(let t=0;t<6;t++)for(let e=0;e<4;e++)this.state[t]=void 0!==this.state[t]?this.state[t]:[],this.state[t][e]=null;this.houses=[],this.factories=[],this.roads=[]}addRoad(t,e,s,i=0){const a=new w(this.assetManager,s,!1,{x:64*t,y:64*e,width:64,height:64,angle:i});this.roadLayer.addChild(a),this.state[t][e]=a,this.roads.push(a)}addFactory(t,e){const s=new S({x:64*t,y:64*e,width:64,height:64,sprite:this.assetManager.get("sprite")});this.buildingLayer.addChild(s),this.factories.push(s)}addHouse(t,e){const s=new x(this.assetManager,{x:64*t,y:64*e,width:64,height:64});this.buildingLayer.addChild(s),this.houses.push(s)}getRoad(t,e){return void 0===this.state[t]||void 0===this.state[t][e]?null:this.state[t][e]}resetRoadState(){this.roads.map(t=>{t.isActive=!1})}activateAround(t,e){return[[1,0],[-1,0],[0,-1],[0,1]].reduce((s,[i,a])=>{const r=this.getRoad(t+i,e+a);return null!==r&&!1===r.isActive&&(r.isActive=!0,s.push([t+i,e+a])),s})}updateRoads(){this.resetRoadState();let t=[];for(this.factories.forEach(e=>{const s=Math.floor(e.x/64),i=Math.floor(e.y/64),a=this.getRoad(s,i);null!==a&&(a.isActive=!0,t.push([s,i]))});t.length>0;)console.log(t),t=t.reduce((t,[e,s])=>(t.concat(this.activateAround(e,s)),t),[]),console.log(t)}}class k extends g{init(){const t=new b(0,0,this.game.assetManager,[[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0]]);this.root.addChild(t),t.addRoad(0,0,1,0),t.addRoad(0,1,1,0),t.addRoad(1,0,1,90),t.addRoad(1,1,1,0),t.addRoad(3,0,1,0),t.addFactory(0,0),t.addFactory(1,0),t.addHouse(0,2),t.addHouse(1,2),t.updateRoads(),this.field=t,console.log(this.game.assetManager);const e=this.game.assetManager.get("back");this.backPattern=this.game.context.createPattern(e.data,"repeat")}update(t){if(this.game.inputManager.isKeyUp(i)){const t=Math.floor(this.game.inputManager.getMouseX()/64),e=Math.floor(this.game.inputManager.getMouseY()/64),s=this.field.getRoad(t,e);null!==s&&s.state===m&&(s.state=p,this.game.tweenManager.create(s,{angle:s.angle+90},200).then(()=>{this.field.updateRoads(),s.state=m,s.angle=360!==s.angle?s.angle:0}))}this.root.update(t)}draw(t){t.rect(0,0,320,240),t.fillStyle=this.backPattern,t.fill(),this.root.draw(t)}}(new class extends c{init(){this.assetManager.add("sprite","assets/sprites/sprites.png").add("back","assets/sprites/back.png"),this.stateManager.add("game",k)}}).start("game")}]);