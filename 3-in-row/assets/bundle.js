!function(t){var e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)s.d(i,a,function(e){return t[e]}.bind(null,a));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);const i="mouse_1";class a{constructor(t){this.element=t,this.keyState={},this.keyUpState={},this.mouseState={x:0,y:0},document.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("mousemove",this.onMouseMove.bind(this))}onMouseUp(t){const e=this.getCursorPosition(t);switch(this.mouseState.x=e.x,this.mouseState.y=e.y,t.which){case 1:return void(this.keyState[i]=!1)}}onMouseDown(t){const e=this.getCursorPosition(t);switch(this.mouseState.x=e.x,this.mouseState.y=e.y,t.which){case 1:return void(this.keyState[i]=!0)}}onMouseMove(t){const e=this.getCursorPosition(t);this.mouseState.x=e.x,this.mouseState.y=e.y}getMouseX(){return this.mouseState.x}getMouseY(){return this.mouseState.y}getMousePosition(){return[this.getMouseX(),this.getMouseY()]}reset(){this.keyUpState={}}update(t){this.keyUpState={},this.keyState=Object.keys(this.keyState).reduce((t,e)=>!1===this.keyState[e]?(delete this.keyState[e],this.keyUpState[e]=!0,t):(t[e]=this.keyState[e],t),{})}isKeyUp(t){return!0===this.keyUpState[t]}isKeyPress(t){return!0===this.keyState[t]}getCursorPosition(t){const e=this.element.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}}class n{constructor(){this.assetsSrc={},this.assets={}}add(t,e){return this.assetsSrc[t]=e,this}get(t){return this.assets[t]}getAssetLoader(t,e){switch(e.split(".").pop()){case"jpg":case"png":return new r(t,e);case"mp3":case"wav":return new h(t,e);default:return null}}load(){const t=Object.keys(this.assetsSrc).map(t=>{const e=this.getAssetLoader(t,this.assetsSrc[t]);if(null===e)throw new Error(`Loader for file ${this.assetsSrc[t]} not found`);return e.load().then(e=>(this.assets[t]=e,e))});return Promise.all(t)}}class r{constructor(t,e){this.url=e,this.name=t,this.data=null}load(){return new Promise((t,e)=>{const s=new Image;s.onerror=(()=>{e(this.url)}),s.onload=(()=>{this.data=s,t(this)}),s.src=this.url})}}class h{constructor(t,e){this.url=e,this.name=t,this.data=null}load(){return new Promise((t,e)=>{const s=document.createElement("audio");s.setAttribute("src",this.url),s.addEventListener("canplay",()=>{this.data=s,t(this)},!0),s.addEventListener("error",()=>{e(this.url)}),s.load()})}}class l{constructor(){this.lastTick=null,this.canvas=null,this.context=null,this.tick=this.tick.bind(this),this.canvas=document.getElementById("game"),this.context=this.canvas.getContext("2d"),this.inputManager=new a(this.canvas),this.assetManager=new n}start(){this.load(),this.assetManager.load().then(()=>{this.init(),this.lastTick=Date.now(),window.requestAnimationFrame(this.tick)})}tick(){const t=Date.now(),e=Date.now()-this.lastTick;this.lastTick=t,this.update(e),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.draw(this.context),window.requestAnimationFrame(this.tick)}load(){}init(){}update(){}draw(){}}class o{constructor({x:t=0,y:e=0,sprite:s=null,angle:i=0,animation:a=null,isVisible:n=!0}){this.x=t,this.y=e,this.scaleX=1,this.scaleY=1,this.angle=0,this.sprite=s,this.isVisible=n,this.animations=[],this.currentAnimation=null,null!==this.sprite?(this.width=this.sprite.data.width,this.height=this.sprite.data.height):(this.width=0,this.height=0),this.children=[]}addChild(t){this.children.push(t)}removeChild(t){const e=this.children.indexOf(t);if(-1===e)return!1;this.children.splice(e,1)}addAnimation(t,e){this.animations[t]=e}getFrame(){if(null===this.currentAnimation)return{x:0,y:0,width:this.width,height:this.height};return this.animations[this.currentAnimation].getFrame()}update(t){null!==this.currentAnimation&&this.animations[this.currentAnimation].update(t),this.children.map(e=>{e.update(t)})}draw(t){if(!1!==this.isVisible){if(t.save(),t.translate(this.x,this.y),t.save(),t.translate(this.width/2,this.height/2),t.scale(this.scaleX,this.scaleY),t.translate(-this.width/2,-this.height/2),0!==this.angle&&(t.translate(this.width/2,this.height/2),t.rotate(this.angle*Math.PI/180),t.translate(-this.width/2,-this.height/2)),null!==this.sprite){const e=this.getFrame();t.drawImage(this.sprite.data,e.x,e.y,e.width,e.height,0,0,e.width,e.height)}this.children.map(e=>{e.draw(t)}),t.restore(),t.restore()}}}const d=["img/red-gem","img/yellow-gem","img/green-gem","img/blue-gem"];class c extends o{constructor(t,e,s,i){super({x:t,y:e}),this.type=s,this.isActive=!1,this.assetManager=i,this.gem=new o({sprite:this.assetManager.get(d[this.type])}),this.back=new o({isVisible:this.isActive,sprite:this.assetManager.get("img/back-active")}),this.addChild(this.gem),this.addChild(this.back)}draw(...t){this.back.isVisible=this.isActive,super.draw(...t)}}const u=["img/red-gem","img/yellow-gem","img/green-gem","img/blue-gem"];class g extends o{constructor(t,e,s=5,i=5,a){super({x:t,y:e}),this.sizeX=s,this.sizeY=i,this.state=[],this.assetManager=a,this.back=new o({}),this.gems=new o({}),this.addChild(this.back),this.addChild(this.gems)}initWithRandom(){for(let t=0;t<this.sizeY;t++)for(let e=0;e<this.sizeX;e++){let s=-1;for(;-1===s;)s=this.getRandomCell(e,t);this.back.addChild(new o({x:32*e,y:32*t,sprite:this.assetManager.get("img/back")}));const i=new c(32*e,32*t,s,this.assetManager);this.gems.addChild(i),this.state[e]=void 0!==this.state[e]?this.state[e]:[],this.state[e][t]=i}}getType(t,e){return t<0||t>=this.sizeX?-1:e<0||e>=this.sizeY?-1:null===this.state[t][e]?-1:this.state[t][e].type}getRandomCell(t,e){const s=Math.floor(Math.random()*u.length);return s===this.getType(t-1,e)&&s===this.getType(t-2,e)?-1:s===this.getType(t,e-1)&&s===this.getType(t,e-2)?-1:s}getCell(t,e){return t<0||t>=this.sizeX?null:e<0||e>=this.sizeY?null:this.state[t][e]}swap(t,e,s,i,a){const n=this.getCell(e,s),r=this.getCell(i,a);return null===n||null===r?Promise.reject():(this.state[e][s]=r,this.state[i][a]=n,Promise.all([t.create(n,{x:32*i,y:32*a},200),t.create(r,{x:32*e,y:32*s},200)]))}findLines(){const t={};for(let e=0;e<this.state[0].length;e++)for(let s=0;s<this.state.length;s++){const i=this.getCell(s,e);null!==i&&(i.type===this.getType(s+1,e)&&i.type===this.getType(s+2,e)&&(t[`${s}-${e}`]=i,t[`${s+1}-${e}`]=this.getCell(s+1,e),t[`${s+2}-${e}`]=this.getCell(s+2,e)),i.type===this.getType(s,e+1)&&i.type===this.getType(s,e+2)&&(t[`${s}-${e}`]=i,t[`${s}-${e+1}`]=this.getCell(s,e+1),t[`${s}-${e+2}`]=this.getCell(s,e+2)))}return Object.keys(t).map(e=>t[e])}deleteGem(t,e){return t.create(e,{scaleX:0,scaleY:0,x:e.x+16,y:e.y+16},200).then(()=>{this.state[Math.floor(e.x/32)][Math.floor(e.y/32)]=null,this.gems.removeChild(e)})}fillEmpty(t){const e=[];for(let t=0;t<this.state.length;t++){let s=0;for(let i=this.state[0].length-1;i>=0;i--){let a=this.getCell(t,i);console.log(t,i,a,s),null!==a?0!==s&&(e.push({distance:s,cell:a,x:t,y:i}),this.state[t][i]=null):s++}for(let i=0;i<s;i++){const a=new c(32*t,32*-(i+1),Math.floor(Math.random()*u.length),this.assetManager);this.gems.addChild(a),e.push({distance:s,x:t,y:-(i+1),cell:a})}}return Promise.all(e.map(e=>t.create(e.cell,{y:e.cell.y+32*e.distance},200*e.distance))).then(()=>{e.map(t=>{this.state[t.x][t.y+t.distance]=t.cell})})}}const m=()=>{let t=null,e=null;return{promise:new Promise((s,i)=>{t=s,e=i}),resolve:e=>t(e),reject:t=>e(t)}};class p{constructor(){this.tweenList=[]}create(t,e={},s=1e4){const i=m(),a={isLoop:!0,object:t,duration:s,currentTime:0,easing:t=>t<.5?2*t*t:(4-2*t)*t-1,params:[],deferred:i};return Object.keys(e).map(s=>{a.params.push({param:s,start:t[s],end:e[s]})}),this.tweenList.push(a),i.promise}update(t){this.tweenList=this.tweenList.filter(e=>{let s=!1;return e.currentTime+=t,e.currentTime>e.duration&&(e.currentTime=e.duration,s=!0),e.params.map(t=>{const s=e.easing(e.currentTime/e.duration),i=t.start+(t.end-t.start)*s;e.object[t.param]=i}),!0===s&&e.deferred.resolve(),!s})}}const y="animate";(new class extends l{constructor(t){super(t),this.root=new o({x:0,y:0}),this.tweenManager=new p}load(){this.assetManager.add("img/ltop","assets/field/ltop.png").add("img/rtop","assets/field/rtop.png").add("img/rbottom","assets/field/rbottom.png").add("img/lbottom","assets/field/lbottom.png").add("img/bcenter","assets/field/bcenter.png").add("img/lcenter","assets/field/lcenter.png").add("img/tcenter","assets/field/tcenter.png").add("img/rcenter","assets/field/rcenter.png").add("img/back","assets/cake.png").add("img/back-active","assets/active_back.png").add("img/red-gem","assets/red_gem.png").add("img/yellow-gem","assets/yellow_gem.png").add("img/green-gem","assets/green_gem.png").add("img/blue-gem","assets/blue_gem.png")}init(){this.field=new g(0,0,8,5,this.assetManager),this.field.initWithRandom(),this.field.x=32,this.field.y=32,this.root.addChild(this.field);const t=this.field.back;t.addChild(new o({x:-32,y:-32,sprite:this.assetManager.get("img/ltop")})),t.addChild(new o({x:256,y:-32,sprite:this.assetManager.get("img/rtop")})),t.addChild(new o({x:256,y:160,sprite:this.assetManager.get("img/rbottom")})),t.addChild(new o({x:-32,y:160,sprite:this.assetManager.get("img/lbottom")}));for(let e=0;e<8;e++)t.addChild(new o({x:32*e,y:-32,sprite:this.assetManager.get("img/tcenter")})),t.addChild(new o({x:32*e,y:160,sprite:this.assetManager.get("img/bcenter")}));for(let e=0;e<5;e++){let s=new o({x:-32,y:32*e,sprite:this.assetManager.get("img/lcenter")});t.addChild(s),s=new o({x:256,y:32*e,sprite:this.assetManager.get("img/rcenter")}),t.addChild(s)}this.activeCell=null,this.lines=[]}update(t){if(this.inputManager.update(t),this.tweenManager.update(t),this.state!==y){if("check"===this.state)return this.lines=this.field.findLines(),void(this.state=0===this.lines.length?"move":"delete");if("delete"===this.state)return this.state=y,Promise.all(this.lines.map(t=>this.field.deleteGem(this.tweenManager,t))).then(()=>{this.state="fill"});if("fill"===this.state)return this.state=y,this.field.fillEmpty(this.tweenManager).then(()=>{this.state="check"});if(this.inputManager.isKeyUp(i)){const[t,e]=this.inputManager.getMousePosition(),s=Math.floor((t-32)/32),i=Math.floor((e-32)/32),a=this.field.getCell(s,i);if(null===a)return void this.resetActive();if(null===this.activeCell)return this.activeCell=a,void(this.activeCell.isActive=!0);const n=Math.floor(this.activeCell.x/32),r=Math.floor(this.activeCell.y/32);(1===Math.abs(s-n)&&0===Math.abs(i-r)||0===Math.abs(s-n)&&1===Math.abs(i-r))&&(this.state="animation",this.field.swap(this.tweenManager,n,r,s,i).then(()=>{if(this.lines=this.field.findLines(),0===this.lines.length)return this.field.swap(this.tweenManager,s,i,n,r).then(()=>{this.state="move"});this.state="check"})),this.resetActive()}this.root.update(t)}}draw(t){this.root.draw(t)}resetActive(){null!==this.activeCell&&(this.activeCell.isActive=!1),this.activeCell=null}}).start()}]);