!function(t){var e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)s.d(i,a,function(e){return t[e]}.bind(null,a));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);const i="mouse_1",a="ArrowLeft",r="ArrowRight",n="ArrowUp",h="ArrowDown",o=" ";class u{constructor(t){this.element=t,this.keyState={},this.keyUpState={},this.mouseState={x:0,y:0},document.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))}onMouseUp(t){const e=this.getCursorPosition(t);switch(this.mouseState.x=e.x,this.mouseState.y=e.y,t.which){case 1:return void(this.keyState[i]=!1)}}onMouseDown(t){const e=this.getCursorPosition(t);switch(this.mouseState.x=e.x,this.mouseState.y=e.y,t.which){case 1:return void(this.keyState[i]=!0)}}onMouseMove(t){const e=this.getCursorPosition(t);this.mouseState.x=e.x,this.mouseState.y=e.y}onKeyDown(t){this.keyState[t.key]=!0}onKeyUp(t){this.keyState[t.key]=!1}getMouseX(){return this.mouseState.x}getMouseY(){return this.mouseState.y}getMousePosition(){return[this.getMouseX(),this.getMouseY()]}reset(){this.keyUpState={}}update(t){this.keyUpState={},this.keyState=Object.keys(this.keyState).reduce((t,e)=>!1===this.keyState[e]?(delete this.keyState[e],this.keyUpState[e]=!0,t):(t[e]=this.keyState[e],t),{})}isKeyUp(t){return!0===this.keyUpState[t]}isKeyPress(t){return!0===this.keyState[t]}getCursorPosition(t){const e=this.element.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}}class l{constructor(){this.assetsSrc={},this.assets={}}add(t,e){return this.assetsSrc[t]=e,this}get(t){return this.assets[t]||null}getAssetLoader(t,e){switch(e.split(".").pop()){case"jpg":case"png":return new d(t,e);case"mp3":case"wav":return new c(t,e);default:return null}}load(){const t=Object.keys(this.assetsSrc).map(t=>{const e=this.getAssetLoader(t,this.assetsSrc[t]);if(null===e)throw new Error(`Loader for file ${this.assetsSrc[t]} not found`);return e.load().then(e=>(this.assets[t]=e,e))});return Promise.all(t)}}class d{constructor(t,e){this.url=e,this.name=t,this.data=null}load(){return new Promise((t,e)=>{const s=new Image;s.onerror=(()=>{e(this.url)}),s.onload=(()=>{this.data=s,t(this)}),s.src=this.url})}}class c{constructor(t,e){this.url=e,this.name=t,this.data=null}load(){return new Promise((t,e)=>{const s=document.createElement("audio");s.setAttribute("src",this.url),s.addEventListener("canplay",()=>{this.data=s,t(this)},!0),s.addEventListener("error",()=>{e(this.url)}),s.load()})}}const g=()=>{let t=null,e=null;return{promise:new Promise((s,i)=>{t=s,e=i}),resolve:e=>t(e),reject:t=>e(t)}};class p{constructor(){this.tweenList=[]}create(t,e={},s=1e4){const i=g(),a={isLoop:!0,object:t,duration:s,currentTime:0,easing:t=>t<.5?2*t*t:(4-2*t)*t-1,params:[],deferred:i};return Object.keys(e).map(s=>{a.params.push({param:s,start:t[s],end:e[s]})}),this.tweenList.push(a),i.promise}update(t){this.tweenList=this.tweenList.filter(e=>{let s=!1;return e.currentTime+=t,e.currentTime>e.duration&&(e.currentTime=e.duration,s=!0),e.params.map(t=>{const s=e.easing(e.currentTime/e.duration),i=t.start+(t.end-t.start)*s;e.object[t.param]=i}),!0===s&&e.deferred.resolve(),!s})}}class m{constructor(t){this.game=t,this.states={},this.currentState=null}add(t,e){this.states[t]=e}change(t){const e=this.states[t]||null;if(null===e)throw new Error(`State '${t}' is undefined`);const s=new e(this.game);s.init(),null!==this.currentState&&this.currentState.leave(),this.currentState=s,s.enter()}update(t){null!==this.currentState&&this.currentState.update(t)}draw(t){null!==this.currentState&&this.currentState.draw(t)}}class f{constructor(){this.lastTick=null,this.canvas=null,this.context=null,this.tick=this.tick.bind(this),this.canvas=document.getElementById("game"),this.context=this.canvas.getContext("2d"),this.inputManager=new u(this.canvas),this.assetManager=new l,this.tweenManager=new p,this.stateManager=new m(this)}start(t=null){this.init(),this.assetManager.load().then(()=>{this.stateManager.change(t),this.lastTick=Date.now(),window.requestAnimationFrame(this.tick)})}tick(){const t=Date.now(),e=Date.now()-this.lastTick;this.lastTick=t,this.inputManager.update(e),this.tweenManager.update(e),this.stateManager.update(e),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.stateManager.draw(this.context),window.requestAnimationFrame(this.tick)}init(){}}class w{constructor({x:t=0,y:e=0,width:s=0,height:i=0,sprite:a=null,angle:r=0,animation:n=null,isVisible:h=!0,currentFrame:o=null}={}){this.x=t,this.y=e,this.scaleX=1,this.scaleY=1,this.angle=r,this.sprite=a,this.isVisible=h,this.animations=[],this.currentAnimation=null,this.currentFrame=o,this.width=s,this.height=i,null!==this.sprite&&0===this.width&&0===this.height&&(this.width=this.sprite.data.width,this.height=this.sprite.data.height),this.children=[]}addChild(t){return this.children.push(t),this}removeChild(t){const e=this.children.indexOf(t);if(-1===e)return!1;this.children.splice(e,1)}addAnimation(t,e){this.animations[t]=e}getFrame(){if(null!==this.currentAnimation){return this.animations[this.currentAnimation].getFrame()}return null!==this.currentFrame?this.currentFrame:{x:0,y:0,width:this.width,height:this.height}}update(t){null!==this.currentAnimation&&this.animations[this.currentAnimation].update(t),this.children.map(e=>{e.update(t)})}draw(t){!1!==this.isVisible&&(t.save(),t.translate(this.x,this.y),t.save(),t.translate(this.width/2,this.height/2),t.scale(this.scaleX,this.scaleY),t.translate(-this.width/2,-this.height/2),0!==this.angle&&(t.translate(this.width/2,this.height/2),t.rotate(this.angle*Math.PI/180),t.translate(-this.width/2,-this.height/2)),this.drawSprite(t),this.children.map(e=>{e.draw(t)}),t.restore(),t.restore())}drawSprite(t){if(null!==this.sprite){const e=this.getFrame();t.drawImage(this.sprite.data,e.x,e.y,e.width,e.height,0,0,e.width,e.height)}}}class y{constructor(t){this.game=t,this.root=new w}load(){}init(){}enter(){}update(t){this.root.update(t)}draw(t){this.root.draw(t)}leave(){}}const S=(t,e,s,i)=>{let a=null;switch(i){case 1:a={x:4,y:4,width:24,height:24};break;case 2:a={x:34,y:4,width:24,height:24};break;case 3:a={x:4,y:34,width:24,height:24};break;case 4:a={x:34,y:34,width:24,height:24};break;case 5:a={x:64,y:34,width:24,height:24}}return new w({x:e,y:s,sprite:t.get("sprite"),currentFrame:a})};class k extends w{constructor(t,e=[],...s){super(...s),this.assetManager=t,this.posX=0,this.posY=0,this.data=[[0,1],[1,1],[0,1]],this.currentRotation=0,this.rotations=[[[0,1],[1,1],[0,1]],[[0,1,0],[1,1,1]],[[1,0],[1,1],[1,0]],[[1,1,1],[0,1,0]]],this.cells=[];for(let t=0;t<this.data.length;t++)for(let e=0;e<this.data[t].length;e++)if(0!==this.data[t][e]){const s=S(this.assetManager,32*e-2*e,32*t-2*t,this.data[t][e]);this.cells.push(s),this.addChild(s)}this.move(4,0)}setPosition(t,e){this.posX=t,this.posY=e,this.x=4+32*this.posX-2*this.posX,this.y=4+32*this.posY-2*this.posY}move(t,e){this.posX+=t,this.posY+=e,this.x=4+32*this.posX-2*this.posX,this.y=4+32*this.posY-2*this.posY}rotate(t=1){this.currentRotation+=t,this.currentRotation>=this.rotations.length&&(this.currentRotation=0),this.currentRotation<0&&(this.currentRotation=this.rotations.length-1),this.data=this.rotations[this.currentRotation];let e=0;for(let t=0;t<this.data.length;t++)for(let s=0;s<this.data[t].length;s++)0!==this.data[t][s]&&(this.cells[e].x=32*s-2*s,this.cells[e].y=32*t-2*t,e++)}}class x extends w{constructor(t,e=[],...s){super(...s),this.data=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,2,0,0,0],[0,0,0,0,0,0,2,0,0,0],[0,0,0,0,0,0,2,0,0,0],[1,1,1,3,4,4,2,5,1,1],[0,0,1,3,4,4,1,5,5,0],[0,1,1,3,3,1,1,1,5,0]],this.assetManager=t,this.backgroundLayout=new w,this.cellLayout=new w,this.addChild(this.backgroundLayout),this.addChild(this.cellLayout);for(let t=0;t<20;t++)for(let e=0;e<10;e++)if(this.backgroundLayout.addChild(new w({x:32*e-2*e,y:32*t-2*t,sprite:this.assetManager.get("sprite"),currentFrame:{x:0,y:62,width:32,height:32}})),0!==this.data[t][e]){const s=S(this.assetManager,4+32*e-2*e,4+32*t-2*t,this.data[t][e]);this.cellLayout.addChild(s)}}check(t,e,s){for(let i=0;i<s.data.length;i++)for(let a=0;a<s.data[i].length;a++){if(void 0===this.data[e+i]||this.data[e+i][t+a])return!0;const r=s.data[i][a],n=this.data[e+i][t+a];if(r+n!==r&&r+n!==n)return!0}return!1}addFigure(t){for(let e=0;e<t.data.length;e++)for(let s=0;s<t.data[e].length;s++){const i=t.data[e][s];if(this.data[t.posY+e][t.posX+s]=i,console.log(i,t.posX,t.posY),0!==i){const a=t.posX+s,r=t.posY+e,n=S(this.assetManager,4+32*a-2*a,4+32*r-2*r,i);this.cellLayout.addChild(n)}}}deleteLines(t){this.cellLayout.children.map(e=>t.create(e,{scaleX:0,scaleY:0,x:e.x-32,y:e.y-36},400))}}const M=1e3;class v extends y{init(){this.deltaTime=0,this.figure=new k(this.game.assetManager,[],{x:120,y:0}),this.field=new x(this.game.assetManager,[],{x:0,y:0}),this.root.addChild(this.field).addChild(this.figure)}update(t){this.game.inputManager.isKeyUp(o)&&this.field.deleteLines(this.game.tweenManager),0===this.deltaTime&&!0===this.field.check(this.figure.posX,this.figure.posY,this.figure)||(this.game.inputManager.isKeyUp(n)&&(this.figure.rotate(),!0===this.field.check(this.figure.posX,this.figure.posY,this.figure)&&this.figure.rotate(-1)),this.game.inputManager.isKeyUp(a)&&!1===this.field.check(this.figure.posX-1,this.figure.posY,this.figure)&&this.figure.move(-1,0),this.game.inputManager.isKeyUp(r)&&!1===this.field.check(this.figure.posX+1,this.figure.posY,this.figure)&&this.figure.move(1,0),this.deltaTime+=this.game.inputManager.isKeyPress(h)?10*t:t,this.deltaTime>=M&&(!1===this.field.check(this.figure.posX,this.figure.posY+1,this.figure)?this.figure.move(0,1):(this.field.addFigure(this.figure),this.figure.setPosition(4,0)),this.deltaTime=0),this.figure.y>600&&this.figure.setPosition(4,0))}}(new class extends f{init(){this.assetManager.add("sprite","assets/img/tetris2x.png"),this.stateManager.add("game",v)}}).start("game")}]);